---
title: "R Notebook"
output: html_notebook
---


```{r setup}
library(tidyverse)
library(countrycode)
library(readxl)
library(lme4)
library(interplot)
library(lubridate)
library(summarytools)
library(vdemdata)
```

Loading data

Note: check on how massmob data merges with nelda. We want cases where this is no protest after the election to score as 0.

```{r}
nelda <- read_xls(here::here("Data", "NELDA.xls"))
ecav <- read_xls(here::here("Data", "ECAV datatset_Version 1.2.xls"))
#vdem.data <- read_rds("C:/Users/colharv/Documents/Research projects/Country_Year_V-Dem_Full_others_R_v11.1/Country_Year_V-Dem_Full+others_R_v11.1/V-Dem-CY-Full+Others-v11.1.rds") #Switch between these two for work desktop vs. laptop
vdem.data <- vdem
lji <- read.csv(here::here("Data", "LJI-estimates-20140422.csv"))
```

Cleaning nelda variables--this will have to be done for all used variables
```{r}
nelda <- nelda %>% dplyr::rename(first.mp.election = nelda2)
nelda <- nelda %>% rename(protests = nelda9)
nelda <- nelda %>% rename(inc.fav.cancel = nelda34)
nelda <- nelda %>% rename(inc.lose = nelda24)
nelda <- nelda %>% rename(inc.termlimit = nelda8)
nelda <- nelda %>% rename(econ.crisis.nelda = nelda18)
nelda <- nelda %>% rename(opp.votegain = nelda7)
nelda <- nelda %>% rename(nelda.protests.fraud = nelda30)
nelda <- nelda %>% rename(new.elections.held = nelda37)
nelda <- nelda %>% rename(inc.replaced.prot = nelda41)
nelda <- nelda %>% rename(preelection_concerns = nelda11)
nelda <- nelda %>% rename(harass_opp = nelda15)
nelda <- nelda %>% rename(opp_leaders_prevented = nelda13)
nelda <- nelda %>% rename(unscheduled_election = nelda6)
nelda <- nelda %>% rename(inc.run = nelda21)
nelda <- nelda %>% rename(chosen.successor = nelda22)






nelda <- nelda %>% mutate(elections.cancel.prot = ifelse(is.na(new.elections.held)==T, NA, ifelse(nelda35 == "yes" & new.elections.held == "yes", 1, 0)))
nelda <- nelda %>% mutate(first.mp.election = ifelse(first.mp.election == "yes", 1, ifelse(first.mp.election == "no", 0, NA)))
nelda <- nelda %>% mutate(protests = ifelse(protests == "yes", 1, ifelse(protests == "no", 0, NA)))
nelda <- nelda %>% mutate(inc.fav.cancel = ifelse(inc.fav.cancel == "yes", 1, ifelse(inc.fav.cancel == "no", 0, NA)))
nelda <- nelda %>% mutate(inc.fav.cancel.protests = ifelse(nelda35 == "yes", 1, 0))
nelda <- nelda %>% mutate(opp.fav.cancel = ifelse(nelda32 == "yes", 1, 0))
nelda <- nelda %>% mutate(inc.lose = ifelse(inc.lose == "yes", 1, ifelse(inc.lose == "no", 0, NA)))

nelda <- nelda %>% mutate(inc.termlimit.num = ifelse(types == "Legislative/Parliamentary" & inc.termlimit == "N/A", 0, ifelse(types == "Executive" & inc.termlimit == "yes", 1,                                                                                                                       ifelse(types == "Executive" & inc.termlimit == "no", 0, NA))))
nelda <- nelda %>% mutate(preelection_concerns = ifelse(preelection_concerns == "yes", 1, ifelse(preelection_concerns == "no", 0, NA)))
nelda <- nelda %>% mutate(harass_opp = ifelse(nelda3 == "No", 1, ifelse(harass_opp == "yes", 1, ifelse(harass_opp == "no", 0, NA))))
nelda <- nelda %>% mutate(opp_leaders_prevented = ifelse(nelda3 == "No", "In general", ifelse(opp_leaders_prevented == "yes", "Specifically", ifelse(opp_leaders_prevented == "no", "No", NA))))

                          
nelda <- nelda %>% mutate(unscheduled_election = ifelse(is.na(unscheduled_election)==T, NA, ifelse(unscheduled_election == "yes" | unscheduled_election == "N/A", 1, 0)))   #"N/A" here refers to no common expectation for election timing                        
          

nelda <- nelda %>% mutate(econ.crisis.nelda = ifelse(econ.crisis.nelda == "yes", 1, ifelse(econ.crisis.nelda == "no", 0, NA)))
nelda <- nelda %>% mutate(opp.votegain = ifelse(opp.votegain == "yes", 1, ifelse(opp.votegain == "no", 0, NA)))
nelda <- nelda %>% mutate(nelda.protests.fraud = ifelse(protests == 0, 0, ifelse(nelda.protests.fraud == "yes", 1, ifelse(nelda.protests.fraud == "no", 0, NA))))
nelda <- nelda %>% mutate(inc.replaced.prot = ifelse(inc.replaced.prot == "yes", 1, 0))
nelda <- nelda %>% mutate(new.elections.held = ifelse(new.elections.held == "yes", 1, 0))

nelda <- nelda %>% mutate(chosen.successor = ifelse(inc.run == "no" & chosen.successor == "yes", 1, 0))



```



Adding a vdem ID to the other packages

Note: the missing values from NELDA are cases not included in VDEM (e.g. Bahamas, Dominica.)
```{r}
nelda <- nelda %>% mutate(country_id = countrycode(sourcevar = ccode, origin = "gwn", destination = "vdem", 
                                                   custom_match = c("345" = "198"))) #Fixes Serbia; only non-match that needs fixing; others are microstates / not in V-Dem
 #Missing matches here look to be countries below the population threshold: some Carib. islands, Monaco, etc.
lji <- lji %>% mutate(country_id = countrycode(sourcevar = ccode, origin = "cown", 
                                               destination = "vdem",
                                               custom_match = c("345" = "198"))) #ID code is the same as above

nelda <- nelda %>% mutate(country_id_year = paste(country_id, year, sep = "_"))
lji <- lji %>% mutate(country_id_year = paste(country_id, year, sep = "_"))
vdem.data <- vdem.data %>% mutate(country_id_year = paste(country_id, year, sep = "_"))

ecav <- ecav %>% mutate(country_id = countrycode(sourcevar = ccode, origin = "cown", destination = "vdem",
                                                 custom_match = c("345" = "198")))

```

VDEM variables to lag
v2x_polyarchy, v2x_libdem, v2xpartipdem, v2x_delibdem, v2x_egaldem, v2x_freexp_altinf, v2x_api, v2x_mpi, v2x_frassoc_thick, v2x_suffr, v2xel_frefair, v2x_elecoff, v2x_liberal, v2x_jucon, v2x_partip, v2x_cspart, v2xeg_eqdr, v2psoppaut, v2jureform, v2jupurge, v2jupoatck, v2jupack, v2juaccnt, v2juhcind, v2juncind, v2mecenefm, e_migdppcln, e_migdpgro, e_miinflat

The approach below works for lagging variables by group. Next step is to lag all of the above variables, lag LJI variables, and then merge with nelda.

```{r, warning=FALSE}
vdem.recent <- vdem.data %>% filter(year >= 1944)

vdem.recent <- vdem.recent %>% mutate(elcompindex.m = ifelse(v2xel_frefair == 0, 0, v2x_mpi / v2xel_frefair))
vdem.recent$v2elirreg.inv <- vdem.recent$v2elirreg * -1

vdem.recent$reform_positive <- NA
vdem.recent$reform_positive[vdem.recent$v2jureform_ord <= 1] <- 0
vdem.recent$reform_positive[vdem.recent$v2jureform_ord == 2 ] <- 1

vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(v2elintmon.lag = lag(v2elintmon))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(reform_positive.lag = lag(reform_positive))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(elcompindex.m.1lag = lag(elcompindex.m))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(polyarchy.1lag = lag(v2x_polyarchy))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(libdem.1lag = lag(v2x_libdem))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(partipdem.1lag = lag(v2x_partipdem))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(delibdem.1lag = lag(v2x_delibdem))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(egaldem.1lag = lag(v2x_egaldem))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(altinf.1lag = lag(v2x_freexp_altinf))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(api.1lag = lag(v2x_api))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(mpi.1lag = lag(v2x_mpi))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(frassoc.1lag = lag(v2x_frassoc_thick))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(suffr.1lag = lag(v2x_suffr))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(frefair.1lag = lag(v2xel_frefair))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(elecoff.1lag = lag(v2x_elecoff))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(liberal.1lag = lag(v2x_liberal))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(jucon.1lag = lag(v2x_jucon))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(partip.1lag = lag(v2x_partip))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(cspart.1lag = lag(v2x_cspart))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(eqdr.1lag = lag(v2xeg_eqdr))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(oppaut.1lag = lag(v2psoppaut))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(jureform.1lag = lag(v2jureform))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(jupurge.1lag = lag(v2jupurge))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(jupoatck.1lag = lag(v2jupoatck))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(jupack.1lag = lag(v2jupack))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(juaccnt.1lag = lag(v2juaccnt))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(juhcind.1lag = lag(v2juhcind))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(juncind.1lag = lag(v2juncind))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(mecenefm.1lag = lag(v2mecenefm))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(gdppcln.1lag = lag(e_migdppcln))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(gdpgro.1lag = lag(e_migdpgro))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(inflat.1lag = lag(e_miinflat))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(legcon.1lag = lag(v2xlg_legcon))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(physinteg.1lag = lag(v2x_clphy))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(legcorrupt.lag = lag(v3lgcrrpt))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(exbribe.lag = lag(v2exbribe))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(exembez.lag = lag(v2exembez))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(pubseccorrup.lag = lag(v2excrptps))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(partybarriers.lag = lag(v2psbars))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(natlpartyorg.lag = lag(v2psorgs))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(partybranch.lag = lag(v2psprbrch))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(csrepress.1lag = lag(v2csreprss))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(osorg.1lag = lag(v2cseeorgs))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(civlib.1lag = lag(v2x_clpol))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(jucon.1lag = lag(v2x_jucon))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(legcon.1lag = lag(v2xlg_legcon))

vdem.recent <- vdem.recent %>% group_by(COWcode) %>% mutate(opposition.oversight.lag = lag(v2lgoppart))


## Getting lagged election fraud
countryids <- data.frame(unique(vdem.recent$country_id))
lag_with_ids <- data.frame(country_id_year = NA, v2elirreg.inv.lag = NA)


for (i in 1:nrow(countryids)){
  #lag_with_ids <- data.frame(country_id_year = NA, v2elirreg.inv.lag = NA)
  country <- vdem.recent %>% filter(country_id == countryids[i,1])
  country <- country %>% filter(is.na(v2elirreg.inv) == F)
  country <- country %>% mutate(v2elirreg.inv.lag = lag(v2elirreg.inv))
  lag_with_ids_temp <- country %>% dplyr::select(country_id_year, v2elirreg.inv.lag)
  lag_with_ids <- bind_rows(lag_with_ids, lag_with_ids_temp)
}
lag_with_ids <- lag_with_ids %>% dplyr::select(-COWcode)
vdem.recent <- vdem.recent %>% left_join(lag_with_ids, by = "country_id_year")






##Leading variables for protest after election years
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(prodem.protest.1lead = lead(v2cademmob))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(proauth.protest.1lead = lead(v2caautmob))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(protest.scale.1lead = lead(v2cagenmob))
vdem.recent <- vdem.recent %>% group_by(country_id) %>% mutate(concen.protest.1lead = lead(v2caconmob))


```
Subtracting election integrity variable from additive polyarchy index and judicial constraints from liberal component index
```{r}
vdem.recent <- vdem.recent %>% mutate(polyarchy_no_ei = v2x_api - (.25*v2xel_frefair))

vdem.recent <- vdem.recent %>% mutate(liberal_no_jucon = (v2xcl_rol + v2xlg_legcon)/2)
```


Imporant variables to include but not lag: v2eltvrexo, v2elvotlrg, v2elvotsml, v2ellostlg, v2ellostsl, v2ellostsm, v2ellostss, v2ellovtlg, v2ellovtsm


```{r}
lji <- lji %>% group_by(ccode) %>% mutate(lji.lag = lag(LJI))
```

Cleaning nelda date variable
```{r}
nelda <- nelda %>% mutate(mmdd = ifelse(mmdd < 1000, paste0(0, mmdd), mmdd))
nelda <- nelda %>% mutate(election_mdy = paste0(mmdd, year))
nelda <- nelda %>% mutate(election_mdy = mdy(election_mdy))


```


Merging Nelda with LJI and Vdem

```{r}
lji <- lji %>% filter(is.na(country_id) == FALSE)
nelda <- nelda %>% filter(is.na(country_id) == FALSE)


#Lagging econ crisis

nelda <- nelda %>% group_by(country_id) %>% mutate(econ.crisis.nelda.1lag = lag(econ.crisis.nelda))

#Merging
nelda2 <- nelda %>% merge(lji %>% dplyr::select(LJI, lji.lag, country_id_year), by = "country_id_year")

nelda2 <- nelda2 %>% merge(vdem.recent %>% dplyr::select(v2elintmon.lag, v2elintmon, v2eltvrexo, v2elvotlrg, v2elvotsml, v2ellostlg, v2ellostsl, v2ellostsm, v2ellostss, v2ellovtlg, v2ellovtsm, v2x_polyarchy, v2x_libdem, v2x_partipdem, v2x_delibdem, v2x_egaldem, v2x_freexp_altinf, v2x_api, v2x_mpi, v2x_frassoc_thick, v2x_suffr, v2xel_frefair, v2x_elecoff, v2x_liberal, v2x_jucon, v2x_partip, v2x_cspart, v2xeg_eqdr, v2psoppaut, v2jureform, v2jupurge, v2jupoatck, v2jupack, v2juaccnt, v2juhcind, v2juncind, v2mecenefm, e_migdppcln, e_migdpgro, e_miinflat, v2xlg_legcon, legcon.1lag, polyarchy.1lag, libdem.1lag, partipdem.1lag, v2elirreg.inv.lag,
                                                  delibdem.1lag,
                                                  elcompindex.m.1lag,
                                                  opposition.oversight.lag,
                                                  v2elirreg.inv,
                                                  reform_positive.lag,
                                                  e_regionpol,
                                                  e_mipopula,
                                                  e_miurbani,
                                                  e_miurbpop,
                                                  e_wb_pop, #Population
                                                  v2xps_party, #Party institutionalization
                                                  #v2regoppgroupssize, #Opp group size (categorical)
                                                  v2pscohesv, #Legislative party cohesion
                                                  v2exl_legitratio, 
                                                  v2exl_legitperf,
                                                  v2exl_legitlead,
                                                  v2exl_legitideol,
                                                  v2xnp_regcorr,
                                                  v2xeg_eqprotec,
                                                  v2xeg_eqdr,
                                                  v2xeg_eqaccess,
                                                  v3lgcrrpt,
                                                  legcorrupt.lag,
                                                  exbribe.lag,
                                                  v2exbribe,
                                                  exembez.lag,
                                                  v2exembez,
                                                  pubseccorrup.lag,
                                                  v2excrptps,
                                                  partybarriers.lag,
                                                  v2psbars,
                                                  natlpartyorg.lag,
                                                  v2psorgs,
                                                  partybranch.lag,
                                                  v2psprbrch,
                                                  v2stfisccap_ord,
                                                  v2stfisccap,
                                                  v2pepwrses, #Power distribution by wealth
                                                  v2pepwrsoc, #Power distribution by social group
                                                  v2csreprss,
                                                  csrepress.1lag,
                                                  osorg.1lag,
                                                  v2cseeorgs,
                                                  v2x_clpol,
                                                  civlib.1lag,
                                                  jucon.1lag,
                                                  legcon.1lag,
                                                  v2ex_elechog,
egaldem.1lag ,
altinf.1lag,
api.1lag,
mpi.1lag,
frassoc.1lag,
suffr.1lag,
frefair.1lag,
elecoff.1lag,
liberal.1lag,
jucon.1lag,
partip.1lag,
cspart.1lag,
eqdr.1lag,
oppaut.1lag,
jureform.1lag,
jupurge.1lag,
jupoatck.1lag,
jupack.1lag,
juaccnt.1lag,
juhcind.1lag,
juncind.1lag,
mecenefm.1lag,
gdppcln.1lag,
gdpgro.1lag,
inflat.1lag,
v2elvotbuy,
v2elirreg,
v2elintim, v2elfrfair,
physinteg.1lag, v2x_clphy,
polyarchy_no_ei,
liberal_no_jucon, v2elaccept,
v2cademmob, #pro-democracy mass mob
v2caautmob, #pro-autoc mass mob
v2cagenmob, #scale of mobilization
v2caconmob, #concentration of mobilization in the capital
v2x_regime,
prodem.protest.1lead,
proauth.protest.1lead,
protest.scale.1lead,
concen.protest.1lead,
country_id_year), by = "country_id_year")

nelda2 <- nelda2 %>% mutate(winner.margin = ifelse(types == "Executive", v2elvotlrg/100, v2ellovtlg/100))
nelda2 <- nelda2 %>% mutate(presidential = ifelse(types == "Executive", 1, 0))

#

nelda2 <- nelda2 %>% mutate(weakstate = ifelse(is.na(v2stfisccap_ord) == T, NA, ifelse(v2stfisccap_ord == 0 | v2stfisccap_ord == 1, 1, 0)))
nelda2 <- nelda2 %>% mutate(rentierstate = ifelse(is.na(v2stfisccap_ord) == T, NA, ifelse(v2stfisccap_ord == 2, 1, 0)))
nelda2 <- nelda2 %>% mutate(taxstate = ifelse(is.na(v2stfisccap_ord) == T, NA, ifelse(v2stfisccap_ord == 3 | v2stfisccap_ord == 4, 1, 0)))


```

## World Bank urbanization data

```{r}
urban <- read.csv(here::here("Data", "urbanization_worldbank.csv"))
#urban <- urban %>% rename(Country.Name = X...Country.Name)
test <- urban %>%
  pivot_longer(cols = starts_with("X"),
               names_to = "year")
test <- test %>% mutate(year = gsub("X", "", year))

#Next is line up country codes in test and nelda 2, then merge

library(countrycode)

test <- test %>% mutate(stateid = countrycode(sourcevar = Country.Code, origin = 'iso3c', destination = 'gwc'))
test <- test %>% rename(urban.pct = value)

test <- test %>% mutate(country_id = countrycode(sourcevar = Country.Code, origin = 'iso3c', destination = 'vdem'))
test <- test %>% mutate(country_id_year = paste0(country_id, "_", year))

test <- test %>% dplyr::select(country_id_year, urban.pct)


nelda2 <- nelda2 %>% left_join(test, by = "country_id_year")

```



##Nelda2 looks at ECAV variables as DV


```{r}
rm(vdem.data)
rm(vdem.recent)
rm(lji)
#rm(nelda)
```




Coding anti-gov violence from ecav

```{r}
## Coding anti-government initiation of violence

ecav <- ecav %>% mutate(antigov.violence = 
                          ifelse(EventViolence == 0, 0,
                                 ifelse(ViolenceInitiator == "-99", NA,
                                                  ifelse(ViolenceInitiator == ".1" & Actor1Side == 1, 1, 
                                                  ifelse(ViolenceInitiator == ".2" & Actor2Side == 1, 1,
                                                         ifelse(ViolenceInitiator == "1.1" & Target1Side == 1, 1,
                                                                ifelse(ViolenceInitiator == "2.1" & Target2Side == 1, 1, 0)))))))
```


Coding pro-gov violence from ecav

```{r}
## Coding pro-government initiation of violence

ecav <- ecav %>% mutate(progov.violence = 
                          ifelse(EventViolence == 0, 0,
                                 ifelse(ViolenceInitiator == "-99", NA,
                                                  ifelse(ViolenceInitiator == ".1" & Actor1Side == 0, 1, 
                                                  ifelse(ViolenceInitiator == ".2" & Actor2Side == 0, 1,
                                                         ifelse(ViolenceInitiator == "1.1" & Target1Side == 0, 1,
                                                                ifelse(ViolenceInitiator == "2.1" & Target2Side == 0, 1, 0)))))))
```



```{r}
ecav.pre <- ecav %>% filter(Date < Electiondate)
ecav.pre <- ecav.pre %>% filter(str_detect(EventName, "rotest") == T | str_detect(EventName, "ccupation") == T |
                                  str_detect(EventName, "lockade") == T) #Only captures protests

ecav.post <- ecav %>% filter(Date >= Electiondate)
ecav.post <- ecav.post %>% filter(str_detect(EventName, "rotest") == T | str_detect(EventName, "ccupation") == T |
                                  str_detect(EventName, "lockade") == T) #Only captures protests
```


--Next step is to create and double-check the summaries, make sure that when merged back in with Nelda2 that we get events with zero protests

Grouped summaries
```{r}
count_data_pre <- ecav.pre %>% group_by(NeldaID) %>% summarize(n.events.pre = n())
count_data_post <- ecav.post %>% group_by(NeldaID) %>% summarize(n.events.post = n())



##Duration
max_date <- ecav.post %>% group_by(NeldaID) %>% summarize(latest.event = max(Date))
min_date <- ecav.post %>% group_by(NeldaID) %>% summarize(earliest.event = min(Date))
duration_data <- left_join(min_date, max_date, by = "NeldaID")
duration_data <- duration_data %>% mutate(d.events = as.duration(interval(earliest.event, latest.event)))
duration_data <- duration_data %>% mutate(d.events.num = as.numeric(d.events, "days"))
duration_data <- duration_data %>% mutate(d.events.num = ifelse(d.events.num == 0, 1, d.events.num)) #1-day events

##Size
ecav.post <- ecav.post %>% mutate(ParticipantNumber = ifelse(ParticipantNumber == -99, NA, ParticipantNumber))
size_data_post <- ecav.post %>% group_by(NeldaID) %>% summarize(median.participants = median(ParticipantNumber, na.rm = T))

ecav.pre <- ecav.pre %>% mutate(ParticipantNumber = ifelse(ParticipantNumber == -99, NA, ParticipantNumber))
size_data_pre <- ecav.pre %>% group_by(NeldaID) %>% summarize(median.participants.pre = median(ParticipantNumber, na.rm = T))


## Anti-gov Violence
violence_data_post <- ecav.post %>% group_by(NeldaID) %>% summarize(antigov.violence = sum(antigov.violence, na.rm = T))
violence_data_pre <- ecav.pre %>% group_by(NeldaID) %>% summarize(antigov.violence.pre = sum(antigov.violence, na.rm = T))

## Pro-gov Violence
pg_violence_data_post <- ecav.post %>% group_by(NeldaID) %>% summarize(progov.violence = sum(progov.violence, na.rm = T))
pg_violence_data_pre <- ecav.pre %>% group_by(NeldaID) %>% summarize(progov.violence.pre = sum(progov.violence, na.rm = T))




##Combined
ecav_data_post <- left_join(count_data_post, duration_data, by = "NeldaID")
ecav_data_post <- left_join(ecav_data_post, size_data_post, by = "NeldaID")
ecav_data_post <- left_join(ecav_data_post, violence_data_post, by = "NeldaID")
ecav_data_post <- left_join(ecav_data_post, pg_violence_data_post, by = "NeldaID")



ecav_data_pre <- left_join(count_data_pre, size_data_pre, by = "NeldaID")
ecav_data_pre <- left_join(ecav_data_pre, violence_data_pre, by = "NeldaID")
ecav_data_pre <- left_join(ecav_data_pre, pg_violence_data_pre, by = "NeldaID")


ecav_data <- left_join(ecav_data_post, ecav_data_pre, by = "NeldaID")




## Merge back with NELDA 2
```

Merge ECAV with NELDA

```{r}
nelda2 <- nelda2 %>% rename(NeldaID = electionid)
nelda2 <- left_join(nelda2, ecav_data, by = "NeldaID")
```



## Remove closed autoc and lib dem

```{r}
nelda2.sub <- nelda2 %>% filter(v2x_regime > 0) #Note that coding scheme for electoral democracies allows for "some degree of fraud and irregularities but these did not in the end affect the outcome" (v2elfrfair, which is a component of v2x_regime) 
```


## Remove elections before 1989-10-04 and after 2013-1-13 (ecav range)

```{r}
nelda2.sub <- nelda2.sub %>% filter(election_mdy >= "1989-10-04")
nelda2.sub <- nelda2.sub %>% filter(election_mdy <= "2013-01-13")
```


```{r}

##Cleaning

nelda2.sub <- nelda2.sub %>% mutate(antigov.violence = ifelse(is.na(antigov.violence)==T, 0, antigov.violence))
nelda2.sub <- nelda2.sub %>% mutate(antigov.violence = ifelse(is.na(progov.violence)==T, 0, progov.violence))

nelda2.sub <- nelda2.sub %>% mutate(n.events.post = ifelse(is.na(n.events.post)==T, 0, n.events.post))
nelda2.sub <- nelda2.sub %>% mutate(d.events.num = ifelse(is.na(d.events.num)==T, 0, d.events.num))
#nelda2.sub <- nelda2.sub %>% mutate(median.participants = ifelse(is.na(median.participants)==T, 0, median.participants))

nelda2.sub <- nelda2.sub %>% mutate(any.ecav.protest = ifelse(n.events.post >= 1, 1, 0))

##Making the assumption that NAs for pre-election protest are zero
nelda2.sub <- nelda2.sub %>% mutate(n.events.pre = ifelse(is.na(n.events.pre) == T, 0, n.events.pre))
nelda2.sub <- nelda2.sub %>% mutate(antigov.violence.pre = ifelse(is.na(antigov.violence.pre) == T, 0, antigov.violence.pre))
nelda2.sub <- nelda2.sub %>% mutate(progov.violence.pre = ifelse(is.na(progov.violence.pre) == T, 0, antigov.violence.pre))


##Making the assumption that NAs for post-election protest are zero

nelda2.sub <- nelda2.sub %>% mutate(n.events.post = ifelse(is.na(n.events.post) == T, 0, n.events.post))
nelda2.sub <- nelda2.sub %>% mutate(antigov.violence = ifelse(is.na(antigov.violence) == T, 0, antigov.violence))
nelda2.sub <- nelda2.sub %>% mutate(progov.violence = ifelse(is.na(progov.violence) == T, 0, progov.violence))


```




## Merge with winner share updated

```{r}
winner.shares <- read.csv(here::here("Data", "amended_vote_shares.csv"))
nelda2.sub <- nelda2.sub %>% left_join(winner.shares, by = "NeldaID")

```





## Ideas for adding rate of growth and rate of decay to be used as DVs

 - Quick growth after fraud indicates opp believes state is weak
 - Slow or no growth after fraud indicates opp believes state is strong
 - Quick decay after peak indicates state is strong / believed strong (or not--regime is weak and so quickly collapses)
 - Slow decay after peak indicates state is weak / believed weak
 
The idea here would be:
  - Replace categorical measures with minimum number (average won't work because top category is top-less)
  - Replace -99 with...
  - Filter by election
  - Group by date and sum
  - Fit exponential function regression to find coefficient for 'r' (rate of growth)
  - This becomes the DV for a regression on fraud
  

Instead, because protests don't always follow the exponential distribution, going to create a simple measure of protest growth / decay intensity.

The idea here would be:
  - Replace categorical measures with minimum number (average won't work because top category is top-less)
  - Replace -99 with...
  - Filter by election
  - Group by date and sum
  - Find date of largest protest
  - Calculate max_size / max_date - 0 and max_size / end_date - max_date
  - Merge these values into main dataset by election (NeldaID for example)
  - This becomes the DV for a regression on fraud
 
```{r}
# Example




## Remove things other than protests
ecav_prot <- ecav %>% filter(str_detect(EventName, "rotest") == T | str_detect(EventName, "ccupation") == T |
                                  str_detect(EventName, "lockade") == T) #Only captures protests
```

Replacing NA protest size with average for that wave
```{r}
## Set up holding df

dv_df <- data.frame(NeldaID = NA, avg_size = NA)

## Filter by election and replace -99 with NA for protest size
 
 election_ids <- unique(ecav_prot$NeldaID)
ecav_prot <- ecav_prot %>% mutate(ParticipantNumber = ifelse(ParticipantNumber == -99, NA, ParticipantNumber))
 
for(i in 1:length(election_ids)){ 
  ecav_temp <- ecav_prot %>% filter(NeldaID == election_ids[i])  #There is a loop here
 
    ## Remove protests before election
  ecav_temp <- ecav_temp %>% filter(Date >= Electiondate)
  if(nrow(ecav_temp) == 0){
     new_row <- data.frame(NeldaID = election_ids[i], 
                           avg_size = 0) #No post-election protest

  dv_df[i,] <- new_row
  print(paste0("No post-election protest for observation ", i, "."))
  next
  } else{
 
  new_row <- data.frame(NeldaID = election_ids[i], avg_size = floor(mean(ecav_temp$ParticipantNumber, na.rm = T)))

  dv_df[i,] <- new_row
  print(paste0("Average size for observation ", i, " completed."))
  }
}  

## Merge dv_df back into main dataset
  
ecav_prot <- ecav_prot %>% left_join(dv_df, by = "NeldaID")
  

```

Current to-do: Double-check the output of the size code

```{r}
## Set up holding df

dv_df <- data.frame(NeldaID = NA, prot_intensity = NA, decay_intensity = NA, max_size = NA, day_max = NA)


ecav_prot <- ecav_prot %>% mutate(ParticipantNumber_adj = ifelse(is.na(ParticipantNumber)==T, avg_size, ParticipantNumber))
ecav_prot <- ecav_prot %>% mutate(ParticipantNumber_adj = ifelse(ParticipantNumber_adj == "NaN", 2, ParticipantNumber_adj)) #Assume NA size defaults to category 2

#ecav_rus <- ecav %>% filter(country == "Russia")   # Filter by country
ecav_prot <- ecav_prot %>% mutate(ParticipantNumber_num_min = ifelse(ParticipantNumber_adj == 1, 5, 
                                ifelse(ParticipantNumber_adj == 2, 55, 
                                       ifelse(ParticipantNumber_adj == 3, 550, 
                                              ifelse(ParticipantNumber_adj == 4, 5500,
                                                     ifelse(ParticipantNumber_adj == 5, 10000, NA)))))) 


## Filter by election
 
 election_ids <- unique(ecav_prot$NeldaID)
 
for(i in 1:length(election_ids)){ 
  ecav_temp <- ecav_prot %>% filter(NeldaID == election_ids[i])  #There is a loop here

## Group by date and sum number of participants by date:

 ecav_temp_comb <- ecav_temp %>% mutate(date_col = date(Date)) %>%
    group_by(date_col) %>%
     summarize(total = sum(ParticipantNumber_num_min))

 ## Get eleection date
 
 election_date_temp <- unique(ecav_temp$Electiondate)
 
 ## Remove protests before election
 
 ecav_temp_comb <- ecav_temp_comb %>% filter(date_col >= election_date_temp)
 
 
  if (nrow(ecav_temp_comb) == 0) {
    new_row <- data.frame(election_ids[i], NA, NA, NA, NA)
    dv_df[i,] <- new_row
    print(paste0("No post-election protests for obseveration ", i, ", election ID", election_ids[i], ","))
    next}  #End loop if zero post-election protests

 ## Get date of largest protest
 
 max_data <-  ecav_temp_comb %>% filter(total == max(total, na.rm = T))
 
  # Assign NA to NA size
 if (nrow(max_data)==0){
    new_row <- data.frame(election_ids[i], NA, NA, NA, NA)
    dv_df[i,] <- new_row
    print(paste0("Election observation ", i, " completed. (Note: no size estimate."))
    next
 }
 
  if (nrow(max_data) >= 1) {
    prot_intensity <- max_data$total[1] / (1 + as.numeric(ymd(max_data$date_col[1]) - ymd(election_date_temp))) #[1] gets the first peak
    last_peak <- tail(max_data, n = 1)
    decay_intensity <-  last_peak$total / (1 + as.numeric(max(ecav_temp_comb$date_col) - (ymd(last_peak$date_col))))
    day_max <- as.numeric(ymd(max_data$date_col[1]) - ymd(election_date_temp))
    new_row <- data.frame(election_ids[i], prot_intensity, decay_intensity, max_data$total[1], day_max)
  new_row <- new_row %>% rename(max_size = max_data.total.1.)
    dv_df[i,] <- new_row
    print(paste0("Election observation ", i, " completed. (Note: multiple peaks."))
    next
  }

 ## Calculate DVs
 
 prot_intensity <- max_data$total / (1 + as.numeric(ymd(max_data$date_col) - ymd(election_date_temp)))
 decay_intensity <-  max_data$total / (1 + as.numeric(max(ecav_temp_comb$date_col) - (ymd(max_data$date_col)))) #The +1 is a kludge to prevent Inf values
 
 
 
 ##Add to holding df
  
  day_max <- as.numeric(ymd(max_data$date_col[1])) - as.numeric(ymd(election_date_temp))
  new_row <- data.frame(election_ids[i], prot_intensity, decay_intensity, max_data$total, day_max)
  new_row <- new_row %>% rename(max_size = max_data.total)

  dv_df[i,] <- new_row
  print(paste0("Election observation ", i, " completed."))

 } 
  
  ## Merge dv_df back into main dataset
  
nelda2.sub.b <- nelda2.sub %>% left_join( dv_df, by = "NeldaID")
  
```  
Pick up here with fixing this code:

```{r, eval=FALSE}
dv_df <- data.frame(NeldaID = NA, growth_coef = NA)
for(i in 1:length(election_ids)){
 ecav_temp <- ecav_prot %>% filter(NeldaID == election_ids[i])  #There is a loop here
 
###Getting a regression slope for protest size and time
  ecav_temp_comb <- ecav_temp %>% mutate(date_col = date(Date)) %>%
    group_by(date_col) %>%
     summarize(total = sum(ParticipantNumber_num_min))
  max_date_reg <- ecav_temp_comb %>% filter(total == max(total)) %>%  
   dplyr::select(date_col)
 
 ecav_temp_reg <- ecav_temp %>% filter(as_date(Date) >= as_date(Electiondate))
 ecav_temp_reg <- ecav_temp_reg %>% mutate(date_col = date(Date))
 ecav_temp_reg <- ecav_temp_reg %>% left_join(ecav_temp_comb, by = "date_col")  #Gets totals by date
 
 ecav_temp_reg <- ecav_temp_reg %>% filter(as_date(Date) <= max_date_reg[1,1])
 ecav_temp_reg <- ecav_temp_reg %>% mutate(date_index = as.numeric(ymd(ecav_temp_reg$Date) - ymd(Electiondate)))
 if(nrow(ecav_temp_reg) == 0) {
   new_row <- data.frame(election_ids[i], NA)
   dv_df[i,] <- new_row
   print(paste0("No observations for election number ", i, "."))
   next
 }
 if(length(unique(ecav_temp_reg$Date))==1){
   growth_coef <-  ((ecav_temp_reg$total - 0 )/((ecav_temp_reg$date_index+1)-0))[1] #m = (y2 - y1)/(x2 - x1) #+1 in denominator is a kludge to avoid Inf values for day 0 protests
   new_row <- data.frame(election_ids[i], growth_coef)
   dv_df[i,] <- new_row
   print(paste0("One date observed for election ", i, "."))
   next
 } else {
 
 fit <- lm(total ~ 0 + date_index, ecav_temp_reg)
 sum_table <- summary(fit)
 growth_coef <- sum_table$coefficients[1]
  new_row <- data.frame(election_ids[i], growth_coef)
   dv_df[i,] <- new_row
   print(paste0("Coefficient estimated for election ", i, "."))
 }
 rm(growth_coef)
}

## Merge dv_df back into main dataset
  
nelda2.sub.b <- nelda2.sub.b %>% left_join( dv_df, by = "NeldaID")
```

```{r}
### Getting a regression slope for protest decay over time
# last_date_reg <- ecav_temp_reg %>% filter(Date == max(Date)) %>% slice_head(n=1) %>%
#   dplyr::select(Date)
# ecav_temp_reg_decay <- ecav_temp_reg %>% filter(Date >= as_date(max_date_reg$date_col))
#  ecav_temp_reg_decay <- ecav_temp_reg_deacy %>% mutate(date_index_decay = as.numeric(as_date(ecav_temp_reg_decay$Date) - as_date(max_date_reg$date_col)))
#  if(length(unique(ecav_temp_reg_deacy$Date)) == 1){
#    decay_coef <-  ((0-ecav_temp_reg_decay$total)/(1-0))[1] #m = (y2 - y1)/(x2 - x1) =
#  } else{
#    fit_decay <- lm(total ~ 0 + date_index_decay, ecav_temp_reg_decay)
# sum_table_decay <- summary(fit_decay)
# decay_coef <- sum_table_decay$coefficients[1]
#  }
#}

```



## Coding for prior successful protest in political region

```{r}
success_cases <- nelda2.sub.b %>% filter(inc.replaced.prot == 1 | nelda35 == "yes") %>% dplyr::select(e_regionpol, year, election_mdy)

## Coding rule here: A successful protest counts in its region for 1 year after the election which sparked it; the wave ends 1 year after the last successful protest in a chain

nelda2.sub.b <- nelda2.sub.b %>% mutate(regional_success_lag = ifelse(e_regionpol == 1 & (election_mdy %within% interval(start = "1990-06-17", end = "1991-06-17") | election_mdy %within% interval(start = "2000-09-24", end = "2001-09-24") | election_mdy %within% interval(start = "2003-11-02", end = "2006-11-06")), 1, 
                                      ifelse(e_regionpol == 4 & (election_mdy %within% interval(start = "1997-04-13", end = "1998-04-13") | election_mdy %within% interval(start = "1998-05-23", end = "1999-05-23") | election_mdy %within% interval(start = "2000-10-22", end = "2001-10-22") | election_mdy %within% interval(start = "2007-07-22", end = "2008-07-22") | election_mdy %within% interval(start = "2010-11-28", end = "2011-11-28")), 1, 
                                             ifelse(e_regionpol == 2 & (election_mdy %within% interval(start = "2000-04-09", end = "2001-04-09") | election_mdy %within% interval(start = "2000-05-28", end = "2001-05-28") | election_mdy %within% interval(start = "2006-02-07", end = "2007-02-07")), 1, 
                                                    ifelse(e_regionpol == 8 & (election_mdy %within% interval(start = "1989-11-22", end = "1990-11-22")  | election_mdy %within% interval(start = "1996-02-15", end = "1997-02-15")), 1, 0)))))
```



## Writing

```{r}
write.csv(nelda2.sub.b, here::here("Data", "nelda2_sub_2023-05-30.csv"))
```


## Adding ERT data for regime duration

```{r, eval=FALSE}
nelda2.sub <- read.csv(here::here("Data", "nelda2_sub_2023-05-10.csv"))
ert <- read.csv(here::here("Data", "ert.csv"))
ert <- ert %>% filter(year > 1988)
ert.sub <- ert %>% dplyr::select(year, country_id, country_name, reg_start_year)
ert.sub <- ert.sub %>% mutate(country_id_year = paste(country_id, year, sep = "_"))

## ID numbers are the same because they both use V-dem format

ert.sub <- ert.sub %>% dplyr::select(country_id_year, reg_start_year)


nelda2.sub <- nelda2.sub %>% left_join(ert.sub, by = "country_id_year")

## Getting age of regime

nelda2.sub  <- nelda2.sub %>% mutate(regime_age = year - reg_start_year)

write.csv(nelda2.sub, here::here("Data", "nelda2_sub_2023-05-30.csv"))

```


```{r}  
  ## Plotting for visualizing election protest size
  
  ecav_rus_comb <- ecav_rus_comb %>% filter(date_col > "2012-03-04")
 ecav_rus_comb <- ecav_rus_comb %>% mutate(date_index = date(date_col) - date("2012-03-04"))
 
 ggplot(ecav_rus_comb, aes(x=date_col, y = total)) +
     geom_col()

```

